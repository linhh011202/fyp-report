sequenceDiagram
    participant Client
    participant Controller as AuthController
    participant Service as AuthService
    participant JWT as JwtService
    participant UserSvc as UserService
    participant EmailSvc as EmailService
    participant DB as MongoDB

    rect rgb(230, 245, 255)
        Note over Client,EmailSvc: Password Reset Request Flow
        Client->>Controller: POST /auth/forgot-password
        Note over Client,Controller: Body: {email: "user@example.com"}
        
        Controller->>Service: forgotPassword(email)
        Service->>UserSvc: findOne({email})
        
        alt User not found
            UserSvc-->>Service: null
            Service-->>Client: 200 Please check your inbox
            Note over Service,Client: Security: Same response for non-existent users
        end
        
        UserSvc-->>Service: User document
        
        Service->>Service: Generate 6-digit code
        Service->>UserSvc: updateOne({email}, {resetCode, resetCodeExpiry})
        UserSvc->>DB: Update user
        
        Service->>EmailSvc: sendResetPasswordEmail(email, code)
        
        Service-->>Client: 200 {message: "Please check your inbox"}
    end
    
    rect rgb(255, 245, 230)
        Note over Client,EmailSvc: Password Reset Confirmation Flow
        Client->>Controller: POST /auth/reset-password
        Note over Client,Controller: Body: {email, code, newPassword, confirmNewPassword}
        
        Controller->>Service: resetPassword(dto)
        
        alt Passwords don't match
            Service-->>Client: 422 Passwords do not match
        end
        
        Service->>UserSvc: findOne({email})
        
        alt User not found
            UserSvc-->>Service: null
            Service-->>Client: 404 Account not found
        end
        
        UserSvc-->>Service: User with resetCode
        
        alt Invalid or expired code
            Service-->>Client: 400 Invalid or expired reset code
        end
        
        Service->>UserSvc: updateOne({email}, {password: hashed, resetCode: null})
        UserSvc->>DB: Update user
        
        Service-->>Client: 200 {message: "Password has been reset"}
    end
