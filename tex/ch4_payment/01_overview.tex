\section{Overview}
\label{sec:payment_overview}

The Gateway Dashboard implements a comprehensive payment and subscription system using Stripe as the payment processor. This chapter covers the three interconnected modules that handle plan management, payment processing, and subscription tracking.

\subsection{Payment System Architecture}

Figure~\ref{fig:payment_architecture} illustrates the overall architecture of the payment system, showing the relationships between the Plan, Subscription, and Stripe modules.

\begin{figure}[H]
\centering
\includegraphics[width=0.85\textwidth]{images/payment_architecture.png}
\caption{Payment System Architecture}
\label{fig:payment_architecture}
\end{figure}

The architecture consists of three primary modules:
\begin{itemize}
    \item \textbf{Plan Module}: Manages versioned pricing plans with Redis caching for performance optimization.
    \item \textbf{Stripe Module}: Handles payment processing, checkout sessions, and webhook events from Stripe.
    \item \textbf{Subscription Module}: Tracks user subscriptions with quota and usage monitoring.
\end{itemize}

\subsection{Module Relationships}

\begin{table}[H]
\centering
\begin{tabular}{|l|l|p{5cm}|}
\hline
\textbf{Module} & \textbf{Dependencies} & \textbf{Responsibility} \\
\hline
Plan & MongoDB, Redis & Plan versioning and caching \\
\hline
Stripe & PlanService, SubscriptionService, Redis & Payment processing and webhooks \\
\hline
Subscription & MongoDB & Quota tracking and access control \\
\hline
\end{tabular}
\caption{Payment Module Dependencies}
\label{tab:payment_modules}
\end{table}

\subsection{Payment Data Flow}

The payment flow follows a clear sequence:
\begin{enumerate}
    \item \textbf{Plan Selection}: User browses available plans retrieved via the Plan module.
    \item \textbf{Checkout Initiation}: Frontend requests a Stripe checkout session from the API.
    \item \textbf{Payment Processing}: User completes payment on Stripe's hosted checkout page.
    \item \textbf{Webhook Processing}: Stripe sends a webhook notification; API matches payment to plan.
    \item \textbf{Subscription Creation}: Subscription module creates/updates user subscription with quota.
    \item \textbf{Access Control}: Subsequent API requests are validated against subscription quota.
\end{enumerate}

\subsection{Database Schema Overview}

The payment system uses two primary collections:

\begin{table}[H]
\centering
\begin{tabular}{|l|p{8cm}|}
\hline
\textbf{Collection} & \textbf{Purpose} \\
\hline
\texttt{plans} & Versioned pricing plans with features and Stripe price IDs \\
\hline
\texttt{subscriptions} & User subscription status, quota limits, and usage tracking \\
\hline
\end{tabular}
\caption{Payment System Collections}
\label{tab:payment_collections}
\end{table}

\subsection{Chapter Organization}

This chapter is organized as follows:
\begin{itemize}
    \item \textbf{Section 4.2}: Plan management with versioning and Redis caching
    \item \textbf{Section 4.3}: Subscription management and quota tracking
    \item \textbf{Section 4.4}: Stripe integration for payment processing
\end{itemize}
